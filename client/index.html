<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zetta Online</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="astar.js"></script>
    <script src="stats.js/build/stats.js"></script>
    <style>
        * {
            margin: 0px;
            padding: 0px;
            overflow: hidden;
            font-family: Arial, Helvetica, sans-serif;
            outline: none;
        }

        #form {
            background: linear-gradient(193deg, #667db6, #0082c8, #0082c8, #667db6);
            padding: 8px;
            width: 100vw;
            height: 100vh;
            position: absolute;
        }

        .input {
            border: 1px solid black;
            padding: 8px;
            margin: 5px;
            border-radius: 4px;
        }

        .button {
            border: 1px solid black;
            padding: 8px;
            margin: 5px;
            border-radius: 4px;
            background-color: deepskyblue;
            color: white;
        }

        .button:hover {
            background-color: aqua;
            color: black;
        }

        #chat_box {
            z-index: 4;
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 50%;
            padding: 8px;
            margin-left: 25%;
            display: none;
        }

        #open_room_nav {
            z-index: 4;
            position: fixed;
            bottom: 20px;
            left: 0px;
            width: 50px;
            height: 50px;
            display: none;
            margin-left: 8px;
        }

        #open_shop {
            z-index: 4;
            position: fixed;
            bottom: 70px;
            left: 0px;
            width: 50px;
            height: 50px;
            display: none;
            margin-left: 8px;
        }

        #open_inventory {
            z-index: 4;
            position: fixed;
            bottom: 120px;
            left: 0px;
            width: 50px;
            height: 50px;
            display: none;
            margin-left: 8px;
        }

        img {
            -webkit-touch-callout: none;
            /* iOS Safari */
            -webkit-user-select: none;
            /* Safari */
            -khtml-user-select: none;
            /* Konqueror HTML */
            -moz-user-select: none;
            /* Old versions of Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
            /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
        }

        #room_nav {
            position: absolute;
            z-index: 9;
            background-color: #EBE9DF;
            text-align: center;
            display: none;
            top: 28px;
            left: 20px;
            width: 400px;
            height: 80vh;
            border-radius: 5px;
            max-width: calc(100% - 40px);
            max-height: 75%;
        }

        .floating_close {
            position: absolute;
            right: 10px;
            width: 20px;
            height: 20px;
            border: 2px solid black;
            border-radius: 4px;
            background-color: #BD3B2F;
            color: white;
            margin-top: -5px;
            font-weight: bold;
            font-size: larger;
            cursor: pointer;
            top: 10px;
        }

        .floating_window {
            position: absolute;
            z-index: 9;
            background-color: #EBE9DF;
            text-align: center;
            display: none;
            top: 28px;
            left: 20px;
            width: 500px;
            height: 80vh;
            border-radius: 5px;
            max-width: calc(100% - 40px);
            max-height: 60%;
        }

        .floating_window_header {
            cursor: move;
            z-index: 10;
            background-color: #367897;
            color: #fff;
            border-radius: 5px;
            border-bottom-left-radius: 0px;
            border-bottom-right-radius: 0px;
            font-weight: bold;
            font-size: 13px;
            height: 30px;
            line-height: 2.3;
        }

        #room_nav_header {
            cursor: move;
            z-index: 10;
            background-color: #367897;
            color: #fff;
            border-radius: 5px;
            border-bottom-left-radius: 0px;
            border-bottom-right-radius: 0px;
            font-weight: bold;
            font-size: 13px;
            height: 30px;
            line-height: 2.3;
        }

        #close_room_nav {
            position: absolute;
            right: 10px;
            width: 20px;
            height: 20px;
            border: 2px solid black;
            border-radius: 4px;
            background-color: #BD3B2F;
            color: white;
            margin-top: -5px;
            font-weight: bold;
            font-size: larger;
            cursor: pointer;
            top: 10px;
        }

        .inventory_type,
        .shop_type,
        .room_nav_type {
            padding: 5px;
            border: 1px solid black;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            cursor: pointer;
            background-color: #CAC9C1;
        }



        .active_room_nav {
            border-bottom: 1px solid #EBE9DF;
            background-color: #EBE9DF;
        }

        .room_list {
            width: 90%;
            margin-left: 5%;
            height: 70%;
            margin-top: 20px;
            overflow-y: scroll;
        }

        .room_list_item {
            width: 100%;
            position: relative;
            height: 20px;
            font-size: 15px;
            cursor: pointer;
        }

        .room_list_item:nth-child(odd) {
            background-color: #D5EDFF;
        }

        .room_list_item:nth-child(even) {
            background-color: #FFFFFF;
        }

        .room_list_users {
            background-color: #62B061;
            color: white;
            position: absolute;
            left: 0px;
            width: 36px;
            border-radius: 4px;
        }

        .room_list_users1 {
            background-color: #CAC9C0;
            color: white;
            position: absolute;
            left: 0px;
            width: 36px;
            border-radius: 4px;
        }

        .room_list_name {
            position: absolute;
            left: 45px;
        }

        .bottom_right {
            background: rgb(39, 39, 39);
            color: white;
            width: 100px;
            height: 150px;
            bottom: 80px;
            right: 15px;
            padding: 5px;
            position: fixed;
            display: none;
            text-align: center;
        }

        #action_button_holder {
            position: fixed;
            bottom: 60px;
            right: 15px;
            display: none;
            z-index: 4;
        }

        #shop_content {
            position: relative;
            top: 1px;
            left: 0px;
            width: 100%;
            height: calc(100% - 67px);
        }

        #shop_list {
            position: absolute;
            width: 35%;
            height: 100%;
            top: 0px;
            left: 0px;
            overflow-y: scroll;
        }

        #shop_item_list {
            position: absolute;
            top: 0px;
            right: 0px;
            width: 65%;
            height: 100%;
        }

        .shop_pages {
            cursor: pointer;
            font-size: 12px;
            padding: 5px;
        }

        .shop_pages:nth-child(odd) {
            background: #D5EDFF;
        }

        .shop_pages:nth-child(even) {
            background: #FFFFFF;
        }

        .shop_item {
            border: 1px solid black;
            width: 85px;
            height: 105px;
            float: left;
            margin: 5px;
            background: #DDDDDD;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            position: relative;
        }

        .shop_item:hover {
            background: #FFFFFF;
            padding: 5px;
            margin: 0px;
        }

        .shop_item_name {
            position: absolute;
            bottom: 0px;
        }

        .inventory_item {
            border: 1px solid black;
            width: 85px;
            height: 105px;
            float: left;
            margin: 5px;
            background: #DDDDDD;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            position: relative;
        }

        .inventory_item:hover {
            background: #FFFFFF;
            padding: 5px;
            margin: 0px;
        }

        .inventory_count {
            position: absolute;
            bottom: 0px;
        }
    </style>
</head>

<body>
    <div id="room_nav">
        <div id="room_nav_header">Room Navigator<button id="close_room_nav">&times;</button></div>
        <div
            style="border-bottom: 1px solid black; background-color: white; height: 35px; width: 100%; position: relative; overflow: visible;">
            <div style="position:absolute; width: 100%; bottom: -1px;">
                <button class="room_nav_type active_room_nav" data="public">Public</button>
                <button class="room_nav_type" data="all">All Rooms</button>
                <button class="room_nav_type" data="event">Events?</button>
                <button class="room_nav_type" data="my">My Rooms</button>
            </div>
        </div>
        <div class="room_list"></div>
        <div class="create_room_div"><button id="create_room">Create Room</button></div>
    </div>

    <div id="shop" class="floating_window">
        <div id="shop_header" class="floating_window_header">Shop<button id="close_shop"
                class="floating_close">&times;</button></div>
        <div
            style="border-bottom: 1px solid black; background-color: white; height: 35px; width: 100%; position: relative; overflow: visible;">
            <div style="position:absolute; width: 100%; bottom: -1px;">
                <button class="shop_type active_room_nav" data="front">Front Page</button>
                <button class="shop_type" data="furniture">Furniture</button>
            </div>
        </div>
        <div id="shop_content">
            <div id="shop_list"></div>
            <div id="shop_item_list">Please select a page on left</div>
        </div>
    </div>

    <div id="inventory" class="floating_window">
        <div id="inventory_header" class="floating_window_header">Inventory<button id="close_inventory"
                class="floating_close">&times;</button></div>
        <div
            style="border-bottom: 1px solid black; background-color: white; height: 35px; width: 100%; position: relative; overflow: visible;">
            <div style="position:absolute; width: 100%; bottom: -1px;">
                <button class="inventory_type active_room_nav" data="furniture">Furniture</button>
                <button class="inventory_type" data="badge">Badges</button>
            </div>
        </div>
        <div id="inventory_list"></div>
    </div>

    <div id="form">
        <h3>Zetta Online</h3>
        <div id="login">
            <h1>Login</h1>
            <label for="login_username">Username: </label><input class="input" type="text" name=""
                id="login_username"><br>
            <label for="login_password">Password: </label><input class="input" type="password" name=""
                id="login_password">
            <hr>
            <button id="do_login" class="button">Login</button>
            <button id="goto_register" class="button">Register</button>
        </div>
        <div id="register" style="display: none;">
            <h1>Register</h1>
            <label for="reg_username">Username: </label><input class="input" type="text" name="" id="reg_username"><br>
            <label for="reg_email">Email: </label><input class="input" type="email" name="" id="reg_email"><br>
            <label for="reg_password">Password: </label><input class="input" type="password" name=""
                id="reg_password"><br>
            <label for="conf_password">Confirm password: </label><input class="input" type="password" name=""
                id="conf_password">
            <hr>
            <button id="do_register" class="button">Register</button>
            <button id="goto_login" class="button">Login</button>
        </div>
    </div>

    <canvas id="can"></canvas>
    <img src="transparent.png" id="touch_screen">
    <button id="open_room_nav" class="in_client">Room</button>
    <button id="open_inventory" class="in_client">Inventory</button>
    <button id="open_shop" class="in_client">Shop</button>
    <input type="text" class="in_client" id="chat_box" placeholder="Type here to chat...">
    <div class="bottom_right">
        <p id="bottom_right_title"></p>
        <img id="bottom_right_image" src="" />
    </div>
    <div id="action_button_holder">
        <button class="move">Move</button>
        <button class="pickup">Pick Up</button>
    </div>
    <script>
        (() => {
            const zetta_version = 0.26
            console.log('%c Welcome To \n%cZetta Online%c! \n%c Code by: %cAkob \n%c Version: %c' + zetta_version + ' ', 'background: #222; color: #bada55', 'background: #222; color: #F00', 'background: #222; color: #F8A', 'background: #222; color: #888', 'background: #222; color: #8FA', 'background: #222; color: #888', 'background: #222; color: #8FA');
            const socket = io()
            let stats

            const can = document.querySelector("#can")
            const ctx = can.getContext("2d")
            const tile_width = 64
            const touch_screen = document.querySelector("#touch_screen")
            const imgmap = document.createElement("map")
            const bottom_right = document.querySelector(".bottom_right")
            const action_button_holder = document.querySelector("#action_button_holder")
            const move_furniture = document.querySelector(".move")
            const pickup_furniture = document.querySelector(".pickup")

            const window_inventory = document.querySelector("#inventory")
            const create_room = document.querySelector("#create_room")

            const tile = {
                width: tile_width / 2,
                height: tile_width / 4
            }

            const tile_w = tile.width
            const tile_h = tile.height

            let display_x = 0
            let display_y = 0
            let players = []
            let furnis = []
            let items = []
            let chats = []
            const walking = []
            let my_username = ""
            let my_coins = ""
            let room_type = "public"

            let selected_furni = 0
            let move_furni = 0

            let cursor_x = -1
            let cursor_y = -1

            let graph = ""
            let room = {
                name: "",
                map: [],
                door_x: 0,
                door_y: 0
            }
            let mapping = []

            let typing = false;
            let typing_timer

            let item_image = []
            let draw_array = []
            let draw_ontop = []

            let from_inventory = false
            let not_loading = false

            let debug

            //player image
            let char_image = new Image()
            char_image.src = "characters/character_sprite.png"

            let baju = new Image()
            baju.src = "characters/baju/baju_0000.png"

            const character = {
                width: 64,
                height: 110
            }

            //canvas width and height
            can.width = window.innerWidth
            can.height = window.innerHeight

            //animation settings
            let frame_count = 0
            let current_frame = 0
            let fps_time = Date.now()

            //typing timeout
            const typing_timeout = () => {
                clearTimeout(typing_timer)
                typing_timer = setTimeout(() => {
                    socket.emit("typing", false)
                    typing = false
                }, 3000)
            }

            //initiate game settings...
            const start = () => {
                can.style.zIndex = "1"
                touch_screen.style.width = "100%"
                touch_screen.style.height = "100%"
                touch_screen.style.top = "0px"
                touch_screen.style.left = "0px"
                touch_screen.style.position = "absolute"
                touch_screen.setAttribute('draggable', false)
                touch_screen.setAttribute("usemap", "#imgmap")
                touch_screen.style.zIndex = "2"
                imgmap.setAttribute("name", "imgmap")
                imgmap.style.zIndex = "3"
                document.body.insertBefore(imgmap, document.body.childNodes[0]);

                //fps display
                stats = new Stats();
                stats.showPanel(0)
                document.body.appendChild(stats.dom);
            }

            //main game loop function
            const game = () => {
                stats.begin()
                //clear canvas

                ctx.fillStyle = "#000000"
                ctx.fillRect(0, 0, can.width, can.height)
                if (not_loading) {

                    //draw reset
                    draw_array = []
                    draw_ontop = []

                    //drawing map
                    const map_j = room.map.length
                    for (let j = 0; j < map_j; j++) {
                        const map_i = room.map[j].length
                        for (let i = 0; i < map_i; i++) {
                            if (room.map[j][i]) {
                                const x = display_x + (i * (tile_w * 2) - (i * tile_w) - (j * tile_w))
                                const y = display_y + (j * (tile_h * 2) - (j * tile_h) + (i * tile_h) - (room.map[j][i] * (tile_h / 2)))
                                //ys = y's shadow
                                const ys = display_y + (j * (tile_h * 2) - (j * tile_h) + (i * tile_h))

                                //tile shadow when height
                                ctx.fillStyle = "#555";
                                ctx.beginPath()
                                ctx.moveTo(x, ys - tile_h)
                                ctx.lineTo(x + tile_w, ys)
                                ctx.lineTo(x, ys + tile_h)
                                ctx.lineTo(x - tile_w, ys)
                                ctx.closePath()
                                ctx.fill()

                                //tile surface
                                ctx.strokeStyle = "#8E8E5E"
                                ctx.fillStyle = "#989865"
                                ctx.beginPath()
                                ctx.moveTo(x, y - tile_h)
                                ctx.lineTo(x + tile_w, y)
                                ctx.lineTo(x, y + tile_h)
                                ctx.lineTo(x - tile_w, y)
                                ctx.closePath()
                                ctx.fill()
                                ctx.stroke()

                                //tile left
                                ctx.fillStyle = "#838357"
                                ctx.strokeStyle = "#7A7A51"
                                ctx.beginPath()
                                ctx.moveTo(x - tile_w, y)
                                ctx.lineTo(x, y + tile_h)
                                ctx.lineTo(x, y + tile_h + (tile_h / 2))
                                ctx.lineTo(x - tile_w, y + (tile_h / 2))
                                ctx.closePath()
                                ctx.fill()
                                ctx.stroke()

                                //tile right
                                ctx.fillStyle = "#6F6F49"
                                ctx.strokeStyle = "#676744"
                                ctx.beginPath()
                                ctx.moveTo(x, y + tile_h)
                                ctx.lineTo(x + tile_w, y)
                                ctx.lineTo(x + tile_w, y + (tile_h / 2))
                                ctx.lineTo(x, y + tile_h + (tile_h / 2))
                                ctx.closePath()
                                ctx.fill()
                                ctx.stroke()
                            }
                        }
                    }

                    //move player
                    const now = Date.now()
                    const then = fps_time + (1000 / 15) //setfps
                    if (now >= then) {
                        fps_time = now
                        //animate the walking array
                        walking.forEach((walk, index) => {
                            players.filter(player => {
                                if (walk.id == player.id) {
                                    if (walk.step.length) {
                                        const target_x = walk.step[0].y
                                        const target_y = walk.step[0].x
                                        const player_x = player.x
                                        const player_y = player.y
                                        const player_s = player.step++

                                        if (player_y < target_y) {
                                            player.y = player.y + 0.125
                                        }
                                        if (player_y > target_y) {
                                            player.y = player.y - 0.125
                                        }
                                        if (player_x < target_x) {
                                            player.x = player.x + 0.125
                                        }
                                        if (player_x > target_x) {
                                            player.x = player.x - 0.125
                                        }

                                        if (target_x == player_x && target_y > player_y) {
                                            player.r = 10
                                        }
                                        if (target_x < player_x && target_y > player_y) {
                                            player.r = 11
                                        }
                                        if (target_x < player_x && target_y == player_y) {
                                            player.r = 12
                                        }
                                        if (target_x < player_x && target_y < player_y) {
                                            player.r = 13
                                        }
                                        if (target_x == player_x && target_y < player_y) {
                                            player.r = 14
                                        }
                                        if (target_x > player_x && target_y < player_y) {
                                            player.r = 15
                                        }
                                        if (target_x > player_x && target_y == player_y) {
                                            player.r = 16
                                        }
                                        if (target_x > player_x && target_y > player_y) {
                                            player.r = 17
                                        }

                                        if (player_s >= 7) {
                                            //set player x and y location to the location it should be
                                            player.x = target_x
                                            player.y = target_y
                                            if (player.r >= 9) {
                                                player.r -= 10
                                            }
                                            player.step = 1
                                            walk.step.shift()//remove step already done animation
                                            socket.emit("movement", { id: player.id, x: player.x, y: player.y, r: player.r })
                                        }
                                    }
                                    else {
                                        //regulate balik location x,y player
                                        player.x = Math.round(player.x)
                                        player.y = Math.round(player.y)
                                        //kalau takde movement lagi untuk player ni
                                        walking.splice(index, 1)
                                        player.step = 0
                                        update_map()
                                        socket.emit("movement", { id: player.id, x: player.x, y: player.y, r: player.r })
                                    }
                                }
                            })
                        })
                    }

                    //players
                    players.forEach(player => {
                        const player_x = player.x
                        const player_y = player.y
                        const char_w = character.width
                        const char_h = character.height
                        const pla_x = display_x + (player_x * (tile_w * 2) - (player_x * tile_w) - (player_y * tile_w))
                        const pla_y = display_y + (player_y * (tile_h * 2) - (player_y * tile_h) + (player_x * tile_h) - (room.map[Math.floor(player_y)][Math.floor(player_x)] * (tile_h / 2)))

                        const ontop = {
                            typ: "username",
                            txt: player.username,
                            x: pla_x,
                            y: pla_y - char_h + tile_h
                        }
                        draw_ontop.push(ontop)

                        let cx = char_w * 6
                        let cy = char_h * 2

                        //animation fix?
                        let walk_animation = player.step
                        if (walk_animation >= 5) {
                            walk_animation = walk_animation - 4
                        }

                        if (player.r == 0) {
                            cx = char_w * 0
                            cy = char_h * 0

                        }
                        if (player.r == 1) {
                            cx = char_w * 5
                            cy = char_h * 0
                        }
                        if (player.r == 2) {
                            cx = char_w * 10
                            cy = char_h * 0
                        }
                        if (player.r == 3) {
                            cx = char_w * 0
                            cy = char_h * 2
                        }
                        if (player.r == 4) {
                            cx = char_w * 10
                            cy = char_h * 1
                        }
                        if (player.r == 5) {
                            cx = char_w * 5
                            cy = char_h * 1
                        }
                        if (player.r == 6) {
                            cx = char_w * 0
                            cy = char_h * 1
                        }
                        if (player.r == 7) {
                            cx = char_w * 5
                            cy = char_h * 2
                        }

                        if (player.r == 10) {
                            cx = char_w * (walk_animation + 0) //frame should be 1 - 4
                            cy = char_h * 0
                        }
                        if (player.r == 11) {
                            cx = char_w * (walk_animation + 5)
                            cy = char_h * 0
                        }
                        if (player.r == 12) {
                            cx = char_w * (walk_animation + 10)
                            cy = char_h * 0
                        }
                        if (player.r == 13) {
                            cx = char_w * (walk_animation + 0)
                            cy = char_h * 2
                        }
                        if (player.r == 14) {
                            cx = char_w * (walk_animation + 10)
                            cy = char_h * 1
                        }
                        if (player.r == 15) {
                            cx = char_w * (walk_animation + 5)
                            cy = char_h * 1
                        }

                        if (player.r == 16) {
                            cx = char_w * (walk_animation + 0)
                            cy = char_h * 1
                        }
                        if (player.r == 17) {
                            cx = char_w * (walk_animation + 5)
                            cy = char_h * 2
                        }

                        if (player.state == "sit") {
                            if (player.r <= 8) {
                                cy = char_h * 2
                                if (player.r == 0 || player.r == 1) {
                                    cx = char_w * 10
                                }
                                if (player.r == 2 || player.r == 3) {
                                    cx = char_w * 11
                                }
                                if (player.r == 4 || player.r == 5) {
                                    cx = char_w * 12
                                }
                                if (player.r == 6 || player.r == 7) {
                                    cx = char_w * 13
                                }
                            }
                            else if (player.r > 8) {
                                player.state = "stand"
                            }
                        }

                        const this_drawing = {
                            img: char_image,
                            cx: cx,
                            cy: cy,
                            cw: char_w,
                            ch: char_h,
                            px: pla_x - tile_w,
                            py: pla_y - char_h + (tile_h / 2),
                            pw: tile_w * 2,
                            ph: char_h,
                            real_x: player_y,
                            real_y: player_x
                        }
                        draw_array.push(this_drawing)

                        //typing status
                        if (player.typing) {
                            const typ_x = pla_x + tile_w - 5
                            const typ_y = pla_y - (tile_h * 4) - 10


                            const ontop = {
                                typ: "typing",
                                x: typ_x,
                                y: typ_y
                            }
                            draw_ontop.push(ontop)
                        }
                    })

                    //draw furniture
                    furnis.forEach(furni => {
                        const j = furni.y
                        const i = furni.x
                        if (j >= 0 && i >= 0) {
                            const x = display_x + (i * (tile_w * 2) - (i * tile_w) - (j * tile_w))
                            const y = display_y + (j * (tile_h * 2) - (j * tile_h) + (i * tile_h) - (room.map[j][i] * (tile_h / 2)))

                            const item_index = items.map(item => { return item.id }).indexOf(furni.item_id)

                            const img_height = item_image[item_index].height

                            const cx = x - tile_w
                            const cy = y - item_image[item_index].height + tile_h

                            const this_drawing = {
                                img: item_image[item_index],
                                cx: null,
                                cy: null,
                                cw: null,
                                ch: null,
                                px: cx,
                                py: cy,
                                pw: (tile_w * 2),
                                ph: img_height,
                                real_x: j,
                                real_y: i
                            }
                            if (move_furni != furni.id) {
                                //if furni on move, no need to show here
                                draw_array.push(this_drawing)
                            }
                        }

                    })

                    //draw cursor
                    ctx.strokeStyle = "#FFFFFF"
                    ctx.lineWidth = 2
                    if (cursor_x >= 0 && cursor_y >= 0) {
                        const cur_x = display_x + (cursor_x * (tile_w * 2) - (cursor_x * tile_w) - (cursor_y * tile_w))
                        const cur_y = display_y + (cursor_y * (tile_h * 2) - (cursor_y * tile_h) + (cursor_x * tile_h) - (room.map[cursor_y][cursor_x] * (tile_h / 2)))
                        ctx.beginPath()
                        ctx.moveTo(cur_x, cur_y - tile_h)
                        ctx.lineTo(cur_x + tile_w, cur_y)
                        ctx.lineTo(cur_x, cur_y + tile_h)
                        ctx.lineTo(cur_x - tile_w, cur_y)
                        ctx.closePath()
                        ctx.stroke()
                    }

                    draw_array.sort((a, b) => { return a.real_y - b.real_y })

                    let last_axist
                    draw_array.forEach(lukis => {
                        if (last_axist != lukis.real_y) {
                            last_axist = lukis.real_y
                            let draw = draw_array.filter(this_draw => { return this_draw.real_y == lukis.real_y })
                            draw.sort((a, b) => { return a.real_x - b.real_x })
                            draw.forEach(lukisan => {
                                if (lukisan.cx != null) {
                                    //this is user.... lukis user
                                    ctx.drawImage(lukisan.img, lukisan.cx, lukisan.cy, lukisan.cw, lukisan.ch, lukisan.px, lukisan.py, lukisan.pw, lukisan.ph)
                                    ctx.drawImage(baju, lukisan.cx, lukisan.cy, lukisan.cw, lukisan.ch, lukisan.px, lukisan.py, lukisan.pw, lukisan.ph)
                                }
                                else {
                                    //this is furni
                                    ctx.drawImage(lukisan.img, lukisan.px, lukisan.py, lukisan.pw, lukisan.img.height)
                                    //draw character atas tiles / furni~
                                    draw_array.forEach(pp => {
                                        if (pp.real_x == lukisan.real_x && pp.real_y == lukisan.real_y && pp.cx != null) {
                                            ctx.drawImage(pp.img, pp.cx, pp.cy, pp.cw, pp.ch, pp.px, pp.py, pp.pw, pp.ph)
                                            ctx.drawImage(baju, pp.cx, pp.cy, pp.cw, pp.ch, pp.px, pp.py, pp.pw, pp.ph)
                                        }
                                    })


                                }
                            })

                        }
                    })

                    //draw everything on top
                    draw_ontop.forEach(ontop => {
                        if (ontop.typ == "username") {
                            ctx.textAlign = "center"
                            ctx.fillStyle = "#55555599"
                            const name_length = ctx.measureText(ontop.txt).width
                            ctx.fillRect(ontop.x - (name_length / 2) - 20, ontop.y - 15, name_length + 25, 20)
                            ctx.fillStyle = "#FFa500"
                            ctx.beginPath()
                            ctx.moveTo(ontop.x - (name_length / 2) - 15, ontop.y)
                            ctx.lineTo(ontop.x - (name_length / 2) - 10, ontop.y - 10)
                            ctx.lineTo(ontop.x - (name_length / 2) - 5, ontop.y)
                            ctx.closePath()
                            ctx.fill()
                            ctx.fillStyle = "#FFF"
                            ctx.fillText(ontop.txt, ontop.x, ontop.y)
                        }
                        if (ontop.typ == "typing") {
                            const typ_x = ontop.x
                            const typ_y = ontop.y
                            ctx.strokeStyle = "#000"
                            ctx.fillStyle = "#FFF"
                            ctx.beginPath()
                            ctx.ellipse(typ_x, typ_y, 11, 7, 0, 0, 2 * Math.PI)
                            ctx.closePath()
                            ctx.stroke()
                            ctx.fill()
                            ctx.beginPath()
                            ctx.moveTo(typ_x - 6, typ_y + 7)
                            ctx.lineTo(typ_x - 1, typ_y + 7)
                            ctx.lineTo(typ_x - 6, typ_y + 11)
                            ctx.closePath()
                            ctx.stroke()
                            ctx.fill()
                            ctx.strokeStyle = "#FFF"
                            ctx.beginPath()
                            ctx.moveTo(typ_x - 5.5, typ_y + 6.5)
                            ctx.lineTo(typ_x - 1.5, typ_y + 6.5)
                            ctx.closePath()
                            ctx.stroke()
                            ctx.textAlign = "center"
                            ctx.fillStyle = "#000"
                            ctx.fillText("...", typ_x, typ_y)
                        }
                    })

                    // draw move furni shadow
                    if (move_furni) {
                        const i = cursor_x
                        const j = cursor_y
                        const x = display_x + (i * (tile_w * 2) - (i * tile_w) - (j * tile_w))
                        const y = display_y + (j * (tile_h * 2) - (j * tile_h) + (i * tile_h) - (room.map[cursor_y][cursor_x] * (tile_h / 2)))

                        const furni_info = furnis.find(e => e.id == move_furni)
                        const item_index = items.map(item => { return item.id }).indexOf(furni_info.item_id)

                        const cx = x - tile_w
                        const cy = y - item_image[item_index].height + tile_h
                        ctx.save()
                        ctx.globalAlpha = 0.5;
                        ctx.drawImage(item_image[item_index], cx, cy)
                        ctx.restore()
                    }

                    //chat for players / bubble chat
                    chats.forEach((chat, i) => {
                        ctx.font = 'bold 15px Arial'
                        const chat_username = chat.username + ": "
                        const chat_username_length = ctx.measureText(chat_username).width + 5
                        ctx.font = 'normal 15px Arial'
                        const chat_message = chat.message
                        const chat_message_length = ctx.measureText(chat_message).width + 5
                        const chat_len2 = chat_username_length + chat_message_length

                        const pla_x = display_x + (chat.x * (tile_w * 2) - (chat.x * tile_w) - (chat.y * tile_w))
                        ctx.textAlign = "center";
                        ctx.fillStyle = "#FFF"

                        ctx.beginPath()
                        ctx.arc(pla_x - (chat_len2 / 2) + 5, (can.height / 2) - (i * 25) - 150 + 5, 5, Math.PI + (Math.PI / 2), Math.PI, true)
                        ctx.arc(pla_x - (chat_len2 / 2) + 5, (can.height / 2) - (i * 25) - 130 - 5, 5, Math.PI, Math.PI / 2, true)
                        ctx.arc(pla_x - (chat_len2 / 2) + chat_len2 - 5, (can.height / 2) - (i * 25) - 130 - 5, 5, Math.PI / 2, 0, true)
                        ctx.arc(pla_x - (chat_len2 / 2) + chat_len2 - 5, (can.height / 2) - (i * 25) - 150 + 5, 5, 0, Math.PI + (Math.PI / 2), true)
                        ctx.closePath()
                        ctx.strokeStyle = "#555"
                        ctx.stroke()
                        ctx.fill()
                        ctx.fillStyle = "#000"

                        ctx.textAlign = "start";
                        ctx.font = 'bold 15px Arial'
                        ctx.fillText(chat_username, pla_x - (chat_len2 / 2) + 5, (can.height / 2) - (i * 25) + 15 - 150)
                        ctx.font = "normal 15px Arial"
                        ctx.fillText(chat_message, pla_x - (chat_len2 / 2) + chat_username_length, (can.height / 2) - (i * 25) + 15 - 150)
                    })


                    //name and coins for top right display
                    ctx.font = "normal 15px Arial"
                    ctx.textAlign = "end";
                    ctx.fillStyle = "#FFFFFF"
                    ctx.fillText(my_username, can.width - 20, 40)
                    ctx.fillStyle = "#FFD700"
                    ctx.fillText("💰: " + my_coins, can.width - 20, 60)

                    ctx.fillStyle = "#FAA"
                    ctx.font = "normal 15px Arial   "
                    ctx.textAlign = "start";
                    ctx.fillText("Zetta Online [v" + zetta_version + "]", 100, 20)
                    ctx.fillText("Room: " + room.name, 100, 35)
                }
                else {
                    ctx.font = "bold 15px Arial"
                    ctx.textAlign = "center"
                    ctx.fillStyle = "#0F0"
                    ctx.fillText("Loading room...", can.width / 2, can.height / 2)
                }

                stats.end()
                requestAnimationFrame(game);
            }

            const update_map = () => {
                imgmap.innerHTML = ""

                players.forEach(player => {
                    const player_x = player.x
                    const player_y = player.y
                    const char_w = character.width
                    const char_h = character.height
                    const name_len = ctx.measureText(player.username).width / 2

                    const pla_x = display_x + (player_x * (tile_w * 2) - (player_x * tile_w) - (player_y * tile_w)) - name_len - 15
                    const pla_y = display_y + (player_y * (tile_h * 2) - (player_y * tile_h) + (player_x * tile_h) - (room.map[Math.floor(player_y)][Math.floor(player_x)] * (tile_h / 2))) - char_h + tile_h - 15
                    
                    const x1 = pla_x
                    const y1 = pla_y
                    const x2 = pla_x + 10
                    const y2 = pla_y
                    const x3 = pla_x + 10
                    const y3 = pla_y + 20
                    const x4 = pla_x
                    const y4 = pla_y + 20
                    imgmap.insertAdjacentHTML('beforeend', `<area player_id='${player.id}' class='player_nametag' shape='polygon' coords='${x1},${y1},${x2},${y2},${x3},${y3},${x4},${y4}'>`)
                })

                //draw furniture's map
                furnis.forEach(furni => {
                    const j = furni.y
                    const i = furni.x
                    if (j >= 0 && i >= 0) {
                        const x = display_x + (i * (tile_w * 2) - (i * tile_w) - (j * tile_w))
                        const y = display_y + (j * (tile_h * 2) - (j * tile_h) + (i * tile_h) - (room.map[j][i] * (tile_h / 2)))

                        const found_item = items.find(item => { return item.id == furni.item_id })
                        const item_index = items.map(item => { return item.id }).indexOf(furni.item_id)
                        const furni_type = found_item.type

                        const img_height = item_image[item_index].height
                        const img_width = item_image[item_index].width

                        const cx = x - tile_w
                        const cy = y - img_height + tile_h
                        const cx1 = cx + tile_w
                        const cy1 = cy
                        const cx2 = cx1 + tile_w
                        const cy2 = cy + tile_h
                        const cx3 = cx2
                        const cy3 = cy + img_height - tile_h
                        const cx4 = cx1
                        const cy4 = cy + img_height
                        const cx5 = cx
                        const cy5 = cy3
                        const cx6 = cx
                        const cy6 = cy2
                        const item_id = Number(furni.item_id)
                        if (furni.id != move_furni) {
                            imgmap.insertAdjacentHTML('beforeend', "<area x='" + i + "' y='" + j + "' furni_id='" + furni.id + "' furni_type='" + furni_type + "' class='furniture' shape='polygon' coords='" + cx1 + "," + cy1 + "," + cx2 + "," + cy2 + "," + cx3 + "," + cy3 + "," + cx4 + "," + cy4 + "," + cx5 + "," + cy5 + "," + cx6 + "," + cy6 + "'>")
                        }
                    }
                })

                const map_j = room.map.length
                for (let j = 0; j < map_j; j++) {
                    const map_i = room.map[j].length
                    for (let i = 0; i < map_i; i++) {
                        if (room.map[j][i]) {
                            const x = display_x + (i * (tile_w * 2) - (i * tile_w) - (j * tile_w))
                            const y = display_y + (j * (tile_h * 2) - (j * tile_h) + (i * tile_h) - (room.map[j][i] * (tile_h / 2)))
                            const tm1_x = x
                            const tm1_y = y - tile_h
                            const tm2_x = x + tile_w
                            const tm2_y = y
                            const tm3_x = x
                            const tm3_y = y + tile_h
                            const tm4_x = x - tile_w
                            const tm4_y = y
                            imgmap.insertAdjacentHTML('beforeend', "<area x='" + i + "' y='" + j + "' class='tile' shape='polygon' coords='" + tm1_x + "," + tm1_y + "," + tm2_x + "," + tm2_y + "," + tm3_x + "," + tm3_y + "," + tm4_x + "," + tm4_y + "'>")
                        }
                    }
                }
            }

            const do_register = () => {
                const username = document.querySelector("#reg_username").value
                const email = document.querySelector("#reg_email").value
                const password = document.querySelector("#reg_password").value
                const conf_password = document.querySelector("#conf_password").value
                if (username && email && password && conf_password) {
                    if (password == conf_password) {
                        const username_regex = /^[a-zA-Z0-9]+$/
                        if (username_regex.test(username)) {
                            const email_regex = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
                            if (email_regex.test(email)) {
                                socket.emit("register", { username: username, email: email, password: password })
                            }
                            else {
                                alert("Email address not valid")
                            }
                        }
                        else {
                            alert("Only alphabet (a-z) and numbers (0-9) are allowed for username");
                        }
                    }
                    else {
                        alert("Confirm password not match")
                    }
                }
                else {
                    alert("Please fill all form")
                }
            }

            const do_login = () => {
                const username = document.querySelector("#login_username").value
                const password = document.querySelector("#login_password").value

                if (username && password) {
                    socket.emit("login", { username: username, password: password })
                }
                else {
                    alert("Please fill all username and password");
                }
            }

            document.querySelector("#goto_register").addEventListener("click", () => {
                document.querySelector("#login").style.display = "none"
                document.querySelector("#register").style.display = "block"
            })

            document.querySelector("#goto_login").addEventListener("click", () => {
                document.querySelector("#register").style.display = "none"
                document.querySelector("#login").style.display = "block"
            })

            document.querySelector("#reg_username").addEventListener("keyup", e => {
                if (e.which == 13) {
                    do_register()
                }
            })

            document.querySelector("#reg_email").addEventListener("keyup", e => {
                if (e.which == 13) {
                    do_register()
                }
            })

            document.querySelector("#reg_password").addEventListener("keyup", e => {
                if (e.which == 13) {
                    do_register()
                }
            })

            document.querySelector("#conf_password").addEventListener("keyup", e => {
                if (e.which == 13) {
                    do_register()
                }
            })

            document.querySelector("#login_username").addEventListener("keyup", e => {
                if (e.which == 13) {
                    do_login()
                }
            })
            document.querySelector("#login_password").addEventListener("keyup", e => {
                if (e.which == 13) {
                    do_login()
                }
            })

            document.querySelector("#do_register").addEventListener("click", () => {
                do_register()
            })

            document.querySelector("#do_login").addEventListener("click", () => {
                do_login()
            })

            document.querySelector("#chat_box").addEventListener("keyup", e => {
                typing_timeout()
                if (e.which == 13) {
                    socket.emit("chat", document.querySelector("#chat_box").value)
                    document.querySelector("#chat_box").value = ""
                    socket.emit("typing", false)
                    typing = false
                    clearTimeout(typing_timer)
                }
                else {
                    if (!typing) {
                        typing = true
                        socket.emit("typing", true)
                    }
                }
            })

            move_furniture.addEventListener("click", () => {
                move_furni = selected_furni
                update_map()
            })

            pickup_furniture.addEventListener("click", () => {
                socket.emit("pickup", selected_furni)
                update_map()
            })



            ////////////// Floating menu draf event //////////////////////
            // Make the DIV element draggable:

            document.querySelector("#close_room_nav").addEventListener("click", () => {
                document.querySelector("#room_nav").style.display = "none"
            })
            document.querySelector("#close_inventory").addEventListener("click", () => {
                window_inventory.style.display = "none"
            })
            document.querySelector("#close_shop").addEventListener("click", () => {
                document.querySelector("#shop").style.display = "none"
            })

            document.querySelector("#open_room_nav").addEventListener("click", () => {
                document.querySelector("#room_nav").style.display = "block"
                socket.emit("room_list", { room_type: room_type })
            })
            document.querySelector("#open_shop").addEventListener("click", () => {
                document.querySelector("#shop").style.display = "block"
                socket.emit("shop_list")
            })
            document.querySelector("#open_inventory").addEventListener("click", () => {
                window_inventory.style.display = "block"
                socket.emit("inventory_list")

            })


            const drag_room_nav = elmnt => {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

                const elementDrag = e => {
                    e = e || window.event;
                    e.preventDefault();
                    // calculate the new cursor position:
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    // set the element's new position:
                    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                }

                const closeDragElement = () => {
                    // stop moving when mouse button is released:
                    document.onmouseup = null;
                    document.onmousemove = null;
                }

                const dragMouseDown = e => {
                    e = e || window.event;
                    e.preventDefault();
                    // get the mouse cursor position at startup:
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    // call a function whenever the cursor moves:
                    document.onmousemove = elementDrag;
                }

                if (document.getElementById(elmnt.id + "_header")) {
                    // if present, the header is where you move the DIV from:
                    document.getElementById(elmnt.id + "_header").onmousedown = dragMouseDown;
                } else {
                    // otherwise, move the DIV from anywhere inside the DIV:
                    elmnt.onmousedown = dragMouseDown;
                }

            }

            drag_room_nav(document.querySelector("#room_nav"));
            drag_room_nav(document.querySelector("#inventory"));
            drag_room_nav(document.querySelector("#shop"));

            /////////////////////////////////////////////////

            window.addEventListener("resize", () => {
                can.width = window.innerWidth
                can.height = window.innerHeight
            })

            //experiment copypaste
            let mousedown = false
            let temp_x = 0
            let temp_y = 0

            touch_screen.addEventListener("mousedown", e => {
                mousedown = true
                temp_x = display_x - e.pageX
                temp_y = display_y - e.pageY
            });

            touch_screen.addEventListener("touchstart", e => {
                mousedown = true
                temp_x = display_x - e.touches[0].clientX
                temp_y = display_y - e.touches[0].clientY
            })

            touch_screen.addEventListener("mouseup", () => {
                bottom_right.style.display = "none"
                action_button_holder.style.display = "none"
                move_furni = 0
                selected_furni = 0
                mousedown = false
                //update_map()
                if (from_inventory) {
                    from_inventory = false
                    socket.emit("inventory_list")
                    window_inventory.style.display = "block"
                }
            });
            touch_screen.addEventListener("touchend", () => {
                mousedown = false
                update_map()
                bottom_right.style.display = "none"
                action_button_holder.style.display = "none"
                move_furni = 0
                selected_furni = 0
            });
            touch_screen.addEventListener("touchcancel", () => {
                mousedown = false
                update_map()
                bottom_right.style.display = "none"
                action_button_holder.style.display = "none"
                move_furni = 0
                selected_furni = 0
            });

            touch_screen.addEventListener("mousemove", e => {
                if (mousedown) {
                    display_x = Math.floor(e.pageX + temp_x)
                    display_y = Math.floor(e.pageY + temp_y)
                }
            });

            touch_screen.addEventListener("touchmove", e => {
                if (mousedown) {
                    display_x = Math.floor(e.touches[0].clientX + temp_x)
                    display_y = Math.floor(e.touches[0].clientY + temp_y)
                }
            });

            //sencond part

            let is_click = true;

            document.addEventListener("mousedown", e => {
                if (e.target.className == "tile" || e.target.className == "furniture") {
                    is_click = true
                    mousedown = true
                    temp_x = display_x - e.pageX
                    temp_y = display_y - e.pageY
                }
            });

            document.addEventListener("touchstart", e => {
                if (e.target.className == "tile" || e.target.className == "furniture") {
                    is_click = true
                    mousedown = true
                    temp_x = display_x - e.touches[0].clientX
                    temp_y = display_y - e.touches[0].clientY
                }
            });

            document.addEventListener("mouseup", e => {
                if (e.target.className == "tile") {
                    if (is_click) {
                        bottom_right.style.display = "none"
                        action_button_holder.style.display = "none"
                        if (move_furni) {
                            socket.emit("place_furni", { x: e.target.getAttribute("x"), y: e.target.getAttribute("y"), id: move_furni })
                            move_furni = 0
                            selected_furni = 0
                        }
                        else {
                            socket.emit("move", { x: e.target.getAttribute("x"), y: e.target.getAttribute("y") })
                        }
                    }
                }
                if (e.target.className == "furniture") {
                    if (is_click) {
                        if (e.target.getAttribute("furni_type") == "tile") {
                            socket.emit("move", { x: e.target.getAttribute("x"), y: e.target.getAttribute("y") })
                        }
                        //place furni id and show on left side.... continues
                        const furni_id = e.target.getAttribute("furni_id")
                        selected_furni = furni_id
                        bottom_right.style.display = "block"
                        action_button_holder.style.display = "block"
                        //get furni info and furni's image
                        const furni_info = furnis.find(e => { return e.id == furni_id })
                        const item_info = items.find(e => { return e.id == furni_info.item_id })
                        document.querySelector("#bottom_right_title").innerHTML = item_info.name
                        document.querySelector("#bottom_right_image").src = "items/" + item_info.image
                    }
                }
                if (e.target.className == "player_nametag") {
                    const given_id = e.target.getAttribute("player_id")
                    const this_player = players.find(e => { return e.id == given_id })
                    bottom_right.style.display = "block"
                    document.querySelector("#bottom_right_title").innerHTML = `${this_player.username}`
                    document.querySelector("#bottom_right_image").src = ""
                }

                if (from_inventory) {
                    from_inventory = false
                    socket.emit("inventory_list")
                    window_inventory.style.display = "block"
                }

                mousedown = false
                update_map()
            });

            document.addEventListener("touchend", e => {
                if (e.target.className == "tile") {
                    if (is_click) {
                        bottom_right.style.display = "none"
                        action_button_holder.style.display = "none"
                        if (move_furni) {
                            socket.emit("place_furni", { x: e.target.getAttribute("x"), y: e.target.getAttribute("y"), id: move_furni })
                            move_furni = 0
                            selected_furni = 0
                        }
                        else {
                            socket.emit("move", { x: e.target.getAttribute("x"), y: e.target.getAttribute("y") })
                        }
                    } else {
                        console.log("IS drag");
                    }
                    if (from_inventory) {
                        from_inventory = false
                        socket.emit("inventory_list")
                        window_inventory.style.display = "block"
                    }
                    mousedown = false;
                    update_map();
                    cursor_x = e.target.getAttribute("x");
                    cursor_y = e.target.getAttribute("y");
                }
                if (e.target.className == "furniture") {
                    if (e.target.getAttribute("furni_type") == "tile") {
                        cursor_x = e.target.getAttribute("x");
                        cursor_y = e.target.getAttribute("y");
                    }
                }
            });

            document.addEventListener("touchcancel", e => {
                if (e.target.className == "tile") {
                    mousedown = false;
                    update_map();
                }
            });

            document.addEventListener("mousemove", e => {
                const target_class = e.target.className
                if (target_class == "tile" || target_class == "furniture") {
                    if (mousedown) {
                        is_click = false
                        display_x = Math.floor(e.pageX + temp_x)
                        display_y = Math.floor(e.pageY + temp_y)
                    }
                    else {
                        if (target_class == "tile" || e.target.getAttribute("furni_type") == "tile") {
                            cursor_x = e.target.getAttribute("x")
                            cursor_y = e.target.getAttribute("y")
                        }
                    }
                }
            });

            document.addEventListener("touchmove", e => {
                if (e.target.className == "tile" || e.target.className == "furniture") {
                    if (mousedown) {
                        is_click = false;
                        display_x = Math.floor(e.touches[0].clientX + temp_x)
                        display_y = Math.floor(e.touches[0].clientY + temp_y)
                    }
                }
            });

            document.querySelectorAll(".room_nav_type").forEach(el => {
                document.querySelector(".room_list").innerHTML = "Loading..."
                el.addEventListener("click", () => {
                    document.querySelectorAll(".room_nav_type").forEach(e => {
                        e.classList.remove("active_room_nav");
                    })
                    el.classList.add("active_room_nav");
                    room_type = el.getAttribute("data")
                    socket.emit("room_list", { room_type: room_type })
                })
            })

            create_room.addEventListener("click", () => {
                let prom = window.prompt("Room name:", "My room")
                if (prom) {
                    socket.emit("create_room", prom)
                }
            })

            document.addEventListener("click", el => {
                el.target.classList.forEach(e => {
                    if (e == "goto_room") {
                        not_loading = false
                        move_furni = 0
                        selected_furni = 0
                        bottom_right.style.display = "none"
                        action_button_holder.style.display = "none"

                        console.log("goto_room? ", el.target.getAttribute("data"))
                        socket.emit("goto", { room: el.target.getAttribute("data") })
                        document.querySelector("#room_nav").style.display = "none"
                        chats = []
                        cursor_x, cursor_y = -1
                    }
                    if (e == "shop_pages") {
                        console.log("Hello world...", el.target.getAttribute("data"))
                        socket.emit("shop_list", el.target.getAttribute("data"))
                    }
                    if (e == "shop_item") {
                        const name = el.target.getAttribute("data-name")
                        const price = el.target.getAttribute("data-price")
                        const id = el.target.getAttribute("data")
                        let buy = confirm(`Buy ${name} with ${price} 💰?`)
                        if (buy) {
                            socket.emit("buy", id)
                        }
                    }
                    if (e == "inventory_item") {
                        from_inventory = true
                        const this_furni_id = Number(el.target.getAttribute("data"))
                        const this_item_id = Number(el.target.getAttribute("data-item"))
                        furnis.push({ id: this_furni_id, item_id: this_item_id, owner: 0, room: 0, x: -1, y: -1 })
                        window_inventory.style.display = "none"
                        move_furni = this_furni_id
                    }
                })
            })

            //end
            socket.on('disconnect', () => {
                alert("Disconnected...")
                location.reload();
            });
            socket.on('make_disconnect', () => {
                location.reload();
            });
            socket.on("message", (data) => {
                if (data.type == "error_message") {
                    alert("Error: " + data.message)
                }
                else if (data.type == "alert_box") {
                    alert("MESSAGE:\n" + data.message)
                }
                else if (data.type == "succes_register") {
                    document.querySelector("#register").style.display = "none"
                    document.querySelector("#login").style.display = "block"
                    alert("Success: " + data.message)
                    document.querySelector("#reg_username").value = ""
                    document.querySelector("#reg_email").value = ""
                    document.querySelector("#reg_password").value = ""
                    document.querySelector("#conf_password").value = ""
                }
                else if (data.type == "success_login") {
                    document.querySelector("#form").style.display = "none"
                    document.querySelectorAll(".in_client").forEach(item => {
                        item.style.display = "block"
                    })
                    my_username = data.username
                    my_coins = data.coins
                    start()
                }
            })

            socket.on("room", (data) => {
                data_map = JSON.parse(data.map)
                room.map = data_map
                data_map1 = JSON.parse(data.map)
                mapping = data_map1
                data_door = JSON.parse(data.door)
                room.name = data.name

                //graph = new Graph(room.map, { diagonal: true })
                walking.length = 0
                room.door_x = data_door[0]
                room.door_y = data_door[1]
                let p_display_x = (data_door[1] * (tile_w * 2) - (data_door[1] * tile_w) - (data_door[0] * tile_w)) + (window.innerWidth / 2)
                let p_display_y = - (data_door[0] * (tile_h * 2) - (data_door[0] * tile_h) + (data_door[1] * tile_h) - (room.map[data_door[0]][data_door[1]] * (tile_h / 2))) + (window.innerHeight / 2)
                display_x = Math.floor(p_display_x)
                display_y = Math.floor(p_display_y)
            })

            socket.on("player_update", (data) => {
                players = data
            })

            socket.on("chat", data => {
                chats.unshift({ username: data.username, message: data.message, x: data.x, y: data.y })
            })

            socket.on("move", data => {
                players.filter(player => {
                    //set player gesture to stand
                    if (player.id == data.id) {
                        player.state = data.state
                        if (data.x != player.x || data.y != player.y) {
                            const userMoving = walking.some(player => { return player.id == data.id })
                            if (!userMoving) {
                                //if no movement made by this player...
                                const start = graph.grid[player.y][player.x]
                                const end = graph.grid[data.y][data.x]
                                const result = astar.search(graph, start, end)
                                if (result) {
                                    const path = [];
                                    const res_len = result.length;
                                    for (let i = 0; i < res_len; i++) {
                                        const par = { x: result[i].parent.x, y: result[i].parent.y }
                                        path.push({ x: result[i].x, y: result[i].y, parent: par });
                                    }
                                    walking.push({ id: player.id, step: path });
                                }
                            }
                            else {
                                //player already have moving, check is walking or not here?
                                const start = graph.grid[Math.floor(player.y)][Math.floor(player.x)]
                                const end = graph.grid[data.y][data.x]
                                const result = astar.search(graph, start, end)
                                //resee player's step
                                player.step = 0
                                if (result.length) {
                                    walking.filter(walk => {
                                        if (walk.id == data.id) {
                                            players.filter(player => {
                                                if (data.id == player.id) {
                                                    try {
                                                        player.x = walk.step[0].parent.y
                                                        player.y = walk.step[0].parent.x
                                                        walk.step = result
                                                    }
                                                    catch {

                                                    }
                                                }
                                            })
                                        }
                                    })
                                }
                            }
                        }
                    }
                })
            })

            socket.on("room_list", data => {
                document.querySelector(".room_list").innerHTML = "";
                data.forEach(room => {
                    if (room.users) {
                        document.querySelector(".room_list").insertAdjacentHTML("beforeend", "<div class='room_list_item goto_room' data='" + room.id + "'><div class='room_list_users goto_room' data='" + room.id + "'>" + room.users + "</div><div class='room_list_name goto_room' data='" + room.id + "'>" + room.name + "</div></div>")
                    }
                    else {
                        document.querySelector(".room_list").insertAdjacentHTML("beforeend", "<div class='room_list_item goto_room' data='" + room.id + "'><div class='room_list_users1 goto_room' data='" + room.id + "'>" + room.users + "</div><div class='room_list_name goto_room' data='" + room.id + "'>" + room.name + "</div></div>")
                    }
                })
            })

            socket.on("typing", data => {
                players.forEach(player => {
                    if (player.id == data.id) {
                        player.typing = data.typing
                    }
                })
            })

            socket.on("sit", data => {
                players.forEach(player => {
                    if (player.id == data.id) {
                        player.state = "sit"
                    }
                })
            })

            socket.on("furni", data => {
                setTimeout(() => {

                    furnis = data
                    console.log("Furniture:", furnis)
                    //update furni on maping....
                    const map1 = mapping.length
                    for (let i = 0; i < map1; i++) {
                        const map2 = mapping[i].length
                        for (let j = 0; j < map2; j++) {
                            if (mapping[i][j] >= 1) {
                                mapping[i][j] = 1
                            }
                        }
                    }

                    //mark furni with type default as not walkable
                    furnis.forEach(furni => {
                        const item = items.find(item_find => { return item_find.id == furni.item_id })
                        if (item.type == "default") {
                            mapping[furni.y][furni.x] = 0
                        }
                    })
                    graph = new Graph(mapping, { diagonal: true })

                    update_map()
                    not_loading = true

                }, 500)
            })

            let loading_count = 0
            socket.on("items", data => {
                items = data
                console.log("Items: ", items)
                for (let i = 0; i < items.length; i++) {
                    let img = new Image()
                    item_image.push(img)
                    item_image[i].src = "items/" + items[i].image
                    img.onload = () => {
                        loading_count++
                        if (loading_count >= items.length) {
                            console.log("Done. loading game...")

                            ctx.fillStyle = "#000"
                            ctx.fillRect(0, 0, can.width, can.height)
                            ctx.font = "bold 15px Arial"
                            ctx.textAlign = "center"
                            ctx.fillStyle = "#0F0"
                            ctx.fillText("Welcome to zetta Online....", can.width / 2, can.height / 2)

                            //update_map()
                            setTimeout(game, 2000)
                            //game()
                        }
                        else {
                            ctx.fillStyle = "#000"
                            ctx.fillRect(0, 0, can.width, can.height)
                            ctx.font = "bold 15px Arial"
                            ctx.textAlign = "center"
                            ctx.fillStyle = "#0F0"
                            ctx.fillText("Loading game... " + loading_count + "/" + items.length, can.width / 2, can.height / 2)
                            console.log(loading_count + "/" + items.length)
                        }
                    }
                    img.onerror = () => { alert("Item loading error"); }
                }
            })

            socket.on("update_room", data => {
                data_map = JSON.parse(data.map)
                room.map = data_map
                data_map1 = JSON.parse(data.map)
                mapping = data_map1
                furnis = data.furni
                //update path finder
                const map1 = mapping.length
                for (let i = 0; i < map1; i++) {
                    const map2 = mapping[i].length
                    for (let j = 0; j < map2; j++) {
                        if (mapping[i][j] >= 1) {
                            mapping[i][j] = 1
                        }
                    }
                }
                //mark furni with type default as not walkable
                furnis.forEach(furni => {
                    const item = items.find(item_find => { return item_find.id == furni.item_id })
                    if (item.type == "default") {
                        mapping[furni.y][furni.x] = 0
                    }
                })
                graph = new Graph(mapping, { diagonal: true })
            })

            const shop_list = document.querySelector("#shop_list")
            socket.on("shop_list", data => {
                shop_list.innerHTML = ""
                data.forEach(dat => {
                    shop_list.insertAdjacentHTML("beforeend", `<div class='shop_pages' data='${dat.id}'>${dat.name}</div>`)
                })
            })

            const shop_item_list = document.querySelector("#shop_item_list")
            socket.on("shop_item_list", data => {
                console.log("Furni for page~")
                shop_item_list.innerHTML = ""
                data.forEach(dat => {
                    let item_kedai = items.find(item => { return item.id == dat.item_id })
                    shop_item_list.insertAdjacentHTML("beforeend", `<div class='shop_item' data='${dat.id}' data-name='${dat.name}' data-price='${dat.price}' style="background-image: url('items/${item_kedai.image}'); background-repeat: no-repeat; background-position:center top; background-size: 64px 64px;"><div class='shop_item_name'>${dat.name}<br>${dat.price} 💰</div></div>`)
                })
            })

            socket.on("update_coins", data => {
                my_coins = data
            })

            const inventory_list = document.querySelector("#inventory_list")
            socket.on("inventory_list", data => {
                inventory_list.innerHTML = ""
                this_data = []
                data.forEach(dat => {
                    let item_kedai = items.find(item => { return item.id == dat.item_id })
                    let check_this = this_data.some(this_dat => { return this_dat.item_id == dat.item_id })
                    if (!check_this) {
                        this_data.push({ id: dat.id, item_id: dat.item_id, count: 1, img: item_kedai.image })
                    }
                    else {
                        let this_d = this_data.find(this_dat => { return this_dat.item_id == dat.item_id })
                        this_d.count++
                    }
                })
                this_data.forEach(this_dd => {
                    inventory_list.insertAdjacentHTML("beforeend", `<div class='inventory_item' data='${this_dd.id}' data-item="${this_dd.item_id}" style="background-image: url('items/${this_dd.img}'); background-repeat: no-repeat; background-position:center top; background-size: 64px 64px;"><div class="inventory_count">${this_dd.count}</div></div>`)
                })
            })




        })()
    </script>
</body>

</html>